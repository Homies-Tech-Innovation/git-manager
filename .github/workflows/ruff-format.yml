name: Ruff Python Formatter

on:
  pull_request:
    branches:
      - main

jobs:
  ruff-format:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Python and Ruff
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install ruff

      - name: 🔍 Check for format changes with Ruff (Dry Run)
        id: dry_run
        run: |
          # Run ruff format in check mode to see if any files need reformatting
          # We use || true to prevent the workflow from failing if differences are found (ruff returns exit code 1)
          ruff format . --check || true

          # Capture the output of ruff in check mode to count files that need reformatting.
          # We use the --quiet flag to only get the filenames.
          # The output of `ruff format . --check --quiet` is a list of file paths that would be reformatted.
          formatted_files=$(ruff format . --check --quiet | wc -l)
          echo "formatted_files=$formatted_files" >> $GITHUB_OUTPUT

      - name: Apply formatting if changes found
        if: steps.dry_run.outputs.formatted_files > 0
        id: format_apply
        run: |
          echo "Changes were detected (${{ steps.dry_run.outputs.formatted_files }} files). Applying ruff format..."
          # THIS IS THE CRITICAL CHANGE: Run ruff format WITHOUT --check or --diff to apply changes!
          ruff format .
          echo "Changes applied successfully."

      - name: 📝 Commit formatted files
        if: steps.dry_run.outputs.formatted_files > 0
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: formatted python files with ruff"
          file_pattern: "*.py"
          commit_author: "github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "41898282+github-actions[bot]@users.noreply.github.com"

      - name: 💬 Comment on PR if files were formatted
        if: steps.dry_run.outputs.formatted_files > 0
        uses: actions/github-script@v7
        with:
          script: |
            const formattedFilesCount = process.env.FORMATTED_FILES;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `✅ **Ruff formatted ${formattedFilesCount} file(s).** The changes have been committed to this pull request.`
            })
        env:
          FORMATTED_FILES: ${{ steps.dry_run.outputs.formatted_files }}
